name: Reusable Build & Update

on:
  workflow_call:
    inputs:
      # --- Docker Inputs ---
      docker_image_name:
        required: true
        type: string
        description: "The name of the image (e.g., azytaku/valais-backend)"
      dockerfile:
        required: false
        type: string
        default: "Dockerfile"
        description: "Path to Dockerfile"
      platform:
        required: false
        type: string
        default: "linux/amd64"
        description: "Target platform (e.g. linux/amd64)"
      docker_context:
        required: false
        type: string
        default: "."
      
      # --- GitOps Inputs ---
      config_repo:
        required: true
        type: string
        description: "The org/repo of the config repository"
      values_file_path:
        required: true
        type: string
        description: "Path to the values file inside the config repo"
      yaml_key:
        required: false
        type: string
        default: ".image.tag"
        description: "The YAML path to update"

    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true
      GH_PAT:
        required: true

jobs:
  build-push-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Necessary for pushing tags back to the caller repo

    steps:
      # Checkout Application Code
      - name: Checkout Application Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # using Semantic Version Tag
      - name: Generate Semantic Version
        id: semver
        uses: anothrNick/github-tag-action@1.67.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: patch
          WITH_V: true

      # Dockerhub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      #Build and Push
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.docker_context }}
          file: ${{ inputs.dockerfile }}
          platforms: ${{ inputs.platform }}
          push: true
          tags: |
            ${{ inputs.docker_image_name }}:${{ steps.semver.outputs.new_tag }}
            ${{ inputs.docker_image_name }}:latest

      #Checkout the Config Repo
      - name: Checkout Config Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.config_repo }}
          token: ${{ secrets.GH_PAT }}
          path: config-repo

      # Update the YAML file
      - name: Update Image Tag in Values File
        uses: mikefarah/yq@master
        with:
          # This specifically targets keys like .image.tag inside the file
          cmd: yq -i '${{ inputs.yaml_key }} = "${{ steps.semver.outputs.new_tag }}"' 'config-repo/${{ inputs.values_file_path }}'

      # Commit and Push to Config Repo
      - name: Push to Config Repo
        env:
          # This maps the GitHub data to the shell variables used below
          PR_NUMBER: ${{ github.event.pull_request.number }}
          RUN_ID: ${{ github.run_id }}
        run: |
          cd config-repo
          git config user.name "GitHub Actions CI"
          git config user.email "ci@github.com"

          if [ -z "$PR_NUMBER" ]; then
            CONTEXT="Manual Run (ID: $RUN_ID)"
          else
            CONTEXT="PR #$PR_NUMBER (ID: $RUN_ID)"
          fi
          
          git add ${{ inputs.values_file_path }}
          git commit -m "ci: update ${{ inputs.docker_image_name }} to ${{ steps.semver.outputs.new_tag }} ($CONTEXT)"
          git push